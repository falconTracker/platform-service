<%- include('./side.html') %>
<style scoped>
	.com_top_title:after{
		content:'';
		display:block;
		clear:both;
	}
	.block-time{
		display:flex;
		flex-direction: row;
		justify-content: space-between;
		background:transparent;
	}
	.block-time .item {
		width: 33.33333%;
		float: left;
		border-right: solid 1px #eee;
		overflow: hidden;
		padding: 20px; 
	}
	.block-time .com_h1 {
		font-size: 22px;
		color:#333;
		border-bottom: solid 1px #eee;
		padding-bottom: 10px;
		margin-bottom: 10px; 
		width:100%;
	}
	.block-time .item-full {
		float: left;
		overflow: hidden;
		display:flex;
		flex-wrap: wrap;
		width:49.5%;
		background:#fff;
		padding:20px;
		border-radius:5px;
		box-shadow: 0 1px 2px rgba(150,150,150,0.3);
	}
	
	.block-time .item-vitals {
		float: left;
		overflow: hidden;
		display:flex;
		flex-wrap: wrap;
		width: 100%;
		background:#fff;
		padding:20px;
		border-radius:5px;
		box-shadow: 0 1px 2px rgba(150,150,150,0.3);
	}
	.block-time .item-full:nth-child(:odd) {
		border-right: none; 
	}
	.block-time .item-full li {
		width: 25%;
		float: left;
		margin: 8px 0; 
		width:50%;
	}
	.block-time .item-full li h1 {
		font-size: 20px;
		color: #999; 
		font-weight:300;
	}
	.block-time .item-full h2 {
		font-size: 30px; 
	}
	.block-time .top-width {
		width: 100% !important; 
	}
	.sources-list {
		background: #fff;
		min-height:500px;
	}
	.sources-list .h1 {
		font-size: 22px;
		padding-bottom: 10px;
		margin-bottom: 10px; 
		font-weight:300;
	}
	.sources-list li {
		height: 35px;
		width: 100%;
		background: #f4f4f4;
		line-height: 35px;
		padding-left: 10px;
		position: relative;
		margin-bottom: 10px; 
	}
	.sources-list li:nth-child(odd) {
		background: #f9f9f9; 
	}
	.sources-list li:nth-child(even) {
		background: #eee; 
	}
	.sources-list li .bili {
		position: absolute;
		left: 0;
		top: 0;
		width: 300px;
		height: 35px;
		background: #ffeb3b; 
	}
	.sources-list li .bili.color1 {
		background: #3aa3f7; 
	}
	.sources-list li .bili.color2 {
		background: #25cc4e; 
	}
	.sources-list li .bili.color3 {
		background: #dacd5c; 
	}
	.sources-list li .bili.color4 {
		background: #cddc39; 
	}
	.sources-list li .s1 {
		position: absolute;
		left: 0;
		top: 0;
		width: 100%;
		height: 35px;
		z-index: 10; 
	}
	.sources-list li .s1 span {
		display: inline-block;
		overflow: hidden;
		white-space: nowrap;
		text-overflow: ellipsis; 
	}
	.sources-list li .s1 span.name {
		width: 30%;
		padding-left: 10px; 
	}
	.sources-list li .s1 span.type {
		width: 150px; 
	}
	@media (max-width: 768px) {
		.block-time{
			flex-direction: column;
		}
		.block-time .item-full{
			width:100%;
		}
		.block-time .item-full li h1{
			font-size: 16px;
		}
		.block-time .item-full li h2{
			font-size: 20px;
		}
		.sources-list .h1{
			font-size:15px;
		}
		.com_but_block .btn{
			margin-right:5px;
		}
		.sources-list li .s1{
			font-size:12px;
		}
	}
	
</style>

<style>
	.OyzgL {
  display: grid;
  column-gap: 16px;
  grid-template-columns: 1fr 1fr 1fr;
  margin-bottom: 16px;
	background:#fff;
		padding:20px;
		border-radius:5px;
		width: 100%;
}

@media screen and (max-width:768px) {
  .OyzgL {
    grid-template-columns: 1fr;
    row-gap: unset;
    column-gap: unset
  }
}

@media screen and (min-width:768px) and (max-width:900px) {
  .OyzgL {
    grid-template-columns: 1fr 1fr
  }
}

.PZeSbe {
  padding-top: 16px;
  padding-bottom: 16px;
  display: grid;
  grid-template-columns: 16px 1fr;
  column-gap: 10px;
  row-gap: 8px
}

.XErri {
  margin: 6px 0 10px 10px
}

.XErri.tmOOye {
  width: 10px;
  height: 10px;
  background-color: #0cce6a;
  display: inline-block;
  border-radius: 100%
}

.h1llh {
  font-family: Roboto, Arial, sans-serif;
	font-size: 20px;
	color: #999; 
	font-weight:300;
}

.QKDQJb {
  grid-column-start: 2
}
.cOTkPe {
  margin-top: 8px
}
.Ykn2A {
  font-weight: 500;
	font-size: 30px;
}
.mpkK4e {
  display: grid;
  grid-template-columns: auto auto;
  white-space: nowrap;
  grid-row-gap: 6px;
  margin-top: 18px;
  color: #5f6368
}
.ucyZQe {
  font-family: Roboto, Arial, sans-serif;
  line-height: 1rem;
  font-size: .75rem;
  letter-spacing: .025em;
  font-weight: 400
}
.yvSnCc {
  justify-self: start;
  grid-column: span 2;
  max-width: 100%;
  overflow-x: hidden;
  text-overflow: ellipsis
}
.xNNpEc {
  border-top: 1px solid #dadce0;
  grid-column-start: span 2
}
.Uzon6c {
  overflow-x: hidden;
  text-overflow: ellipsis
}
.hxzvVb {
  color: #018642
}

.SUrRXc {
  color: #ae6032
}

.srMXbd {
  color: #eb0f00
}
</style>
<div class="com_content_body main pb100" id="pages" v-cloak>
	<div class="com_top_title">
		<h1 class="com_h1 fl">页面详情</h1>
		<commonsearch></commonsearch>
	</div>
	<div class="com_block mt20">
		<div><span class="text">完整URL：</span>{{datas.full_url}}</div>
	</div>

	<div class="com_slide_tab_x mt30 mb30">
		<div class="item" :class="{'active':label==1}" @click="checkoutLabel(1)">性能详情</div>
		<div class="item" :class="{'active':label==2}" @click="checkoutLabel(2)">接口请求调用</div>
		<div class="item" :class="{'active':label==4}" @click="checkoutLabel(4)">资源慢加载追踪</div>
	</div>
	
	<div class="block-time mt20" v-show="label==1">
		<div class="item-full div1">
			<h1 class="com_h1">页面加载耗时</h1>
			<ul>
				<li>
					<h1>加载耗时(s)</h1>
					<h2 class="red">{{datas.load_time|toFixed(true)}}</h2>
				</li>
				<li>
					<h1>白屏耗时(ms)</h1>
					<h2 class="red">{{datas.white_time|toFixed}}</h2>
				</li>
				<li>
					<h1>DOM构建耗时(s)</h1>
					<h2>{{datas.dom_time|toFixed(true)}}</h2>
				</li>
				<li>
					<h1>解析DOM耗时(s)</h1>
					<h2>{{datas.analysisDom_time|toFixed(true)}}</h2>
				</li>
				<li>
					<h1>DNS解析耗时(ms)</h1>
					<h2>{{datas.dns_time|toFixed}}</h2>
				</li>
				<li>
					<h1>TCP连接耗时(ms)</h1>
					<h2>{{datas.tcp_time|toFixed}}</h2>
				</li>
				<li>
					<h1>request请求耗时(ms)</h1>
					<h2>{{datas.request_time|toFixed}}</h2>
				</li>
				<li>
					<h1>页面准备耗时(ms)</h1>
					<h2>{{datas.ready_time|toFixed}}</h2>
				</li>
			</ul>
		</div>
		<div class="item-full div1">
			<h1 class="com_h1">页面访问者信息</h1>
			<ul>
				<li>
					<h1>浏览器类型</h1>
					<h2>{{environment.browser}}</h2>
				</li>
				<li>
					<h1>浏览器版本号</h1>
					<h2>{{environment.browser_version}}</h2>
				</li>
				<li>
					<h1>用户操作系统</h1>
					<h2>{{environment.system}}</h2>
				</li>
				<li>
					<h1>操作系统版本</h1>
					<h2>{{environment.system_version}}</h2>
				</li>
				<li>
					<h1>来访省份</h1>
					<h2>{{environment.province||'未知'}}</h2>
				</li>
				<li>
					<h1>来访城市</h1>
					<h2>{{environment.city||'未知'}}</h2>
				</li>
				<li>
					<h1>来访者IP</h1>
					<h2>{{environment.ip}}</h2>
				</li>
				<li>
					<h1>访问时间</h1>
					<h2>{{environment.create_time|date('/',true)}}</h2>
				</li>
			</ul>
		</div>
	</div>

	<div class="block-time mt20" v-if="label==1&&metrics.length!=0">
		<div class="item-vitals div1">
			<h1 class="com_h1">web vitals 信息</h1>
			<div class="OyzgL">
			
				<div class="PZeSbe" v-for="item in metrics">
					<div class="XErri tmOOye"></div><h1 class="h1llh">{{metricType[item.name].name}} ({{item.name}})</h1>
					<div class="QKDQJb">
						<div class="cOTkPe">
							<span class="Ykn2A" :class="item.rating == 'good' ? 'hxzvVb' : item.rating == 'poor' ? 'srMXbd' : 'SUrRXc'">{{item.value.toFixed(5) + (item.name != 'CLS' ? ' 毫秒': "")}}</span>
						</div>
						<div class="mpkK4e ucyZQe">
							<span class="yvSnCc">网页加载</span>
							<span class="xNNpEc"></span>
							<span class="Uzon6c"><span class="hxzvVb">良好</span> (<span class="">{{metricType[item.name].good}}</span>)</span>
							<span class="Uzon6c"><span class="SUrRXc">需要改进</span> (<span class="">{{metricType[item.name]['needs improvement']}}</span>)</span>
							<span class="Uzon6c"><span class="srMXbd">欠佳</span> (<span class="">{{metricType[item.name].poor}}</span>)</span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	
	<div class="com_block sources-list" v-if="label==1">
		<h1 class="h1">页面首屏渲染时资源请求详情信息 <span class="fr">资源总耗时：{{totalTime|toFixed(true)}}</span></h1>
		<div class="com_but_block mt30">
			<button @click="isResourceShow='ALL'" class="btn" :class="{'btn-main':isResourceShow=='ALL'?true:false}">ALL</button>
			<button @click="isResourceShow='XHR'" class="btn" :class="{'btn-main':isResourceShow=='XHR'?true:false}">XHR</button>
			<button @click="isResourceShow='JS'" class="btn" :class="{'btn-main':isResourceShow=='JS'?true:false}">JS</button>
			<button @click="isResourceShow='CSS'" class="btn" :class="{'btn-main':isResourceShow=='CSS'?true:false}">CSS</button>
			<button @click="isResourceShow='IMG'" class="btn" :class="{'btn-main':isResourceShow=='IMG'?true:false}">IMG</button>
			<button @click="isResourceShow='OTHER'" class="btn" :class="{'btn-main':isResourceShow=='OTHER'?true:false}">OTHER</button>
		</div>
		<li v-if="sourceslist.length == 0">
			<span>暂无数据</span>
		</li>
		<div v-else>
			<!-- 资源请求列表 -->
			<li v-for="item in sourceslist">
				<span class="bili" :class="[{'color1':item.initiatorType==='css','color2':item.initiatorType==='img','color3':item.initiatorType==='xmlhttprequest','color4':item.initiatorType==='script'}]"
				 :style="{'width':item.proportion+'%'}"></span>
				<div class="s1">
					<span class="name" :title="item.resourceUrl">{{item.resourceUrl}}</span>
					<span class="type" :title="item.initiatorType">{{item.initiatorType}}</span>
					<span class="type red">{{item.duration|toFixed}}</span>
					<span class="type">{{item.decodedBodySize|toSize}}</span>
				</div>
			</li>
		</div>
	</div>

	<div v-show="label==2">
		<div class="overflow_table">
			<!-- table列表 -->
			<table class="table" v-if="isLoadend&&listAjax.length">
				<tr class="light_color">
					<th>接口请求地址</th>
					<th>调用次数</th>
					<th>平均耗时</th>
					<th>平均BODY大小</th>
					<th>请求方式</th>
				</tr>
				<tr v-for="item in listAjax">
					<td><a :href="'/web/ajaxdetail?url='+item._id.url">{{item._id.url}}</a></td>
					<td class="tc">{{item.count}}</td>
					<td class="tc red">{{item.duration|toFixed}}</td>
					<td class="tc red">{{item.body_size|toSize}}</td>
					<td class="red tc">{{item._id.method}}</td>
				</tr>
			</table>
		</div>
		<!-- 暂无数据 -->
		<div class="tc mt20" v-if="isLoadend&&!listAjax.length">暂无数据!</div>
	</div>

	<div v-show="label==4">
		<div class="overflow_table">
			<table class="table" v-if="isLoadend&&listresources.length">
				<tr class="light_color">
					<th>URL</th>
					<th>资源加载耗时</th>
					<th>性能类型</th>
					<th>资源返回大小</th>
					<th>请求url</th>
					<th>创建时间</th>
				</tr>
				<tr v-for="item in listresources">
					<td><span><a :href="'/web/resourcesdetail?url='+item.name">{{item.name}}</a></span></td>
					<td class="tc red">{{item.duration|toFixed(true)}}</td>
					<td class="tc red">{{item.speed_type==1?'正常':'慢'}}</td>
					<td class="tc">{{item.decodedBodySize|toSize}}</td>
					<td class="tc">{{item.url|limitTo(50)}}</td>
					<td class="tc">{{item.create_time|date('/',true)}}</td>
				</tr>
			</table>
		</div>
	</div>
	<div v-show="label==4">
		<!--  分页 -->
		<div class="tc common_page_style mt10" v-show="listresources.length">
			<div id="copot-page-slowresources" class="copot-page"></div>
		</div>
		<!-- 暂无数据 -->
		<div class="tc mt20" v-if="!listresources.length">暂无数据!</div>
	</div>
</div>

<script>
	const metricType = {
		'FCP': {
			name: 'First Contentful Paint ',
			short: 'FCP',
			good: '≤ 1800 毫秒',
			'needs improvement': ' 1800 毫秒 - 3000 毫秒',
			poor: "≥ 3000 毫秒"
		},
		'LCP': {
			name: "Largest Contentful Paint",
			short: 'LCP',
			good: '≤ 2500 毫秒',
			'needs improvement': ' 2500 毫秒 - 4000 毫秒',
			poor: "≥ 4000 毫秒"
		},
		'INP': {
			name: "Interaction to Next Paint",
			short: 'INP',
			good: '≤ 200 毫秒',
			'needs improvement': ' 200 毫秒 - 500 毫秒',
			poor: "≥ 500 毫秒"
		},
		'CLS': {
			name: "Cumulative Layout Shift",
			short: 'CLS',
			good: '≤ 0.1',
			'needs improvement': ' 0.1 - 0.25',
			poor: "≥ 0.25"
		},
		'TTFB': {
			name: "Time to First Byte",
			short: 'TTFB',
			good: '≤ 800 毫秒',
			'needs improvement': ' 800 毫秒 - 1800 毫秒',
			poor: "≥ 1800 毫秒"
		}
	}
	new Vue({
		el: '#pages',
		data: function () {
			return {
				label:1,
				listAjax:[],
				listresources:[],
				pageNo: 1,
				totalNum: 0,
				pageSize: config.pageSize,
				datas: {},
				metricType,
				environment:{},
				isLoadend: false,
				id: util.getQueryString('id')||'',
				appId: util.getStorage('local', 'appId'),
				sourceslist:[],
				copysourceslist:[],
				totalTime:0,
				isResourceShow:'ALL',
				metrics: [],
			}
		},
		watch:{
			'isResourceShow':function(oldVal, newVal) {
				if(oldVal === newVal) return;
				this.getNewResource();
			}
		},
		filters: {
			toFixed: window.Filter.toFixed,
			toSize: window.Filter.toSize,
			date: window.Filter.date,
			limitTo: window.Filter.limitTo,
		},
		computed: {
			filterRedsourceslist: function () {
				var self = this
				return self.sourceslist.filter(function (resource) {
					let result = true;
					switch(this.isResourceShow){
						case 'ALL':
							result = true;
							break;
						case 'XHR':
							result = resource.initiatorType == 'xmlhttprequest' || resource.initiatorType == 'fetchrequest' ? true : false;
							break;
						case 'JS':
							result = resource.initiatorType == 'script'? true : false;
							break;
						case 'CSS':
							result = resource.initiatorType == 'link' || resource.initiatorType == 'css' ? true : false;
							break;
						case 'IMG':
							result = resource.initiatorType == 'img' ? true : false;
							break;
						case 'OTHER':
							result = resource.initiatorType == 'other' ? true : false;
							break;						
					}
					return result;
				})
			}
		},
		mounted() {
			this.checkoutLabel(1);
		},
		methods: {
			checkoutLabel(label) {
				this.label=label;
				let api = ''
				let pageName = ''

				if(label === 1) {
					this.getinit();
				} else if(label == 2) {
					if(!this.listAjax.length){
						api = 'ajax/getPageAjaxsAvg',
						pageName = '#copot-page-ajax'
						this.getRequestOrSlowResourceList(api, pageName);
					}
				} else if(label == 4) {
					if (!this.listresources.length) {
						api = 'resource/getResourceForType',
						pageName = '#copot-page-slowresources'
						this.getRequestOrSlowResourceList(api, pageName);
					}
				}
			},
			getRequestOrSlowResourceList(api, pageName) {
				this.isLoadend = false;
				util.ajax({
					type:'get',
					url: config.baseApi + api,
					data: {
						type:this.type,
						appId:this.appId,
						pageNo: this.pageNo,
						pageSize: this.pageSize,
						beginTime: this.beginTime,
						endTime: this.endTime,
						url: this.datas.url,
						markPage: this.datas.mark_page
					},
					success: data => {
						this.isLoadend = true;
						if (!data.data.datalist && !data.data.datalist.length) return;
						switch (this.label) {
							case 2:
								this.listAjax = data.data.datalist
								break;
							case 4:
								this.listresources = data.data.datalist
								break;
						}
						new Page({
							parent: $(pageName),
							nowPage: this.pageNo,
							pageSize: this.pageSize,
							totalCount: data.data.totalNum,
							callback: (nowPage, totalPage) => {
								this.pageNo = nowPage;
								this.getRequestOrSlowResourceList(api, pageName);
							}
						});
					}
				})
			},
			getinit() {
				this.isLoadend = false;
				util.ajax({
					type:'get',
					url: config.baseApi + 'pages/getPageDetails',
					data: {
						appId:this.appId,
						id:this.id,
					},
					success: data => {
						this.isLoadend = true;
						this.datas = data.data;
						let sourceslist = data.data.resource_list;
						if(sourceslist.length){
							sourceslist.forEach(item=>{
								this.totalTime+=parseFloat(item.duration);
							})
							sourceslist.forEach(item=>{
								let duration = parseFloat(item.duration);
								item.proportion = (duration/this.totalTime)*100 + 0.1;
							})
							this.sourceslist = this.copysourceslist = sourceslist;
						}
						this.metrics = data.data.metric || [];

						this.getPageEnvironment(data.data.request_id)
					}
				})
			},
			getPageEnvironment(requestId){
				util.ajax({
					type: 'get',
					url: config.baseApi + 'environment/getEnvironmentForPage',
					data: {
						appId: this.appId,
						requestId: requestId,
					},
					success: data => {
						this.environment = data.data;
					}
				})
			},
			getNewResource(){
				const _this = this;
				this.sourceslist = this.copysourceslist.filter(function (resource) {
					let result = true;
					switch (_this.isResourceShow) {
						case 'ALL':
							result = true;
							break;
						case 'XHR':
							result = (resource.initiatorType == 'xmlhttprequest' || resource.initiatorType == 'fetchrequest') ? true : false;
							break;
						case 'JS':
							result = (resource.initiatorType == 'script') ? true : false;
							break;
						case 'CSS':
							result = (resource.initiatorType == 'link' || resource.initiatorType == 'css') ? true : false;
							break;
						case 'IMG':
							result = (resource.initiatorType == 'img') ? true : false;
							break;
						case 'OTHER':
							result = (resource.initiatorType == 'other') ? true : false;
							break;
					}
					return result;
				})
			},
		}
	})
</script>